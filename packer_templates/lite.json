{
	"variables": {
	},
	"builders": [
		{
			"name": "pi",
			"type": "arm-image",
			"image_type": "raspberrypi",
			"iso_url": "https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2022-04-07/2022-04-04-raspios-bullseye-armhf-lite.img.xz",
			"iso_checksum": "sha256:34987327503fac1076e53f3584f95ca5f41a6a790943f1979262d58d62b04175",
			"output_filename": "images/lite/pi.img"
		},
		{
			"name": "sheeva",
			"type": "arm-image",
			"image_mounts": [ "/boot", "/boot/IMD", "/" ],
			"iso_url": "./images/upstream/sheevaplug-s1.img.xz",
			"iso_checksum": "none",
			"output_filename": "images/lite/sheeva.img"
		},
		{
			"name": "rock64",
			"type":"arm-image",
			"image_mounts": [ "/newboot", "/newboot/IMD", "/" ],
			"iso_url": "./images/armbian-mod/rock64.img",
			"iso_checksum": "none",
			"output_filename": "images/lite/rock64.img"
		}
	],
	"provisioners": [
		{
			"only": [ "pi" ],
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"inline": [
                                "mv /etc/ld.so.preload /etc/ld.so.preload.dist"
                        ],
			"skip_clean": true
		},
		{
			"only": [ "sheeva" ],
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "TZ=UCT",
						"DEBIAN_FRONTEND=noninteractive", "LANG=C" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"inline": [
				"chmod 0755 /",
				"chown 0:0 /",
				"/debootstrap/debootstrap --second-stage --merged-usr",
				"# set root password to nosoup4u (sheevaplug image default)",
				"usermod -p '$6$fFo1kfYxV7aTJbir$LpccRu/YSjF/7Ih2NOBhmlcZumM3lhQsbvUXIdkwyuzTVJdTgf5rlOKRRUwUwyqwFxCHQV1Tsio1El0jWNbea.' root"
			],
			"skip_clean": true
		},
		{
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"inline": [
				"mkdir -p /tmp/packer-files"
			],
			"skip_clean": true
		},
		{
			"type": "file",
			"source": "files/lite/",
			"destination": "/tmp/packer-files"
		},
		{
			"type": "shell",
			"environment_vars": [
				"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
				"rootfs_uuid={{user `rootfs_uuid`}}",
				"bootfs_id={{user `bootfs_id`}}",
				"partition_id={{user `partition_id`}}"
			],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"scripts": [
				"./scripts/lite/0_init.sh",
				"./scripts/lite/network-setup.sh"
			]
		}
	],
	"post-processors": [
		{
			"type": "manifest"
		},
		{
			"only": [ "pi" ],
			"type": "shell-local",
			"environment_vars": [
				"rootfs_uuid={{user `rootfs_uuid`}}",
				"bootfs_id={{user `bootfs_id`}}",
				"partition_id={{user `partition_id`}}"
			],
			"scripts": [
				"./scripts/lite/HOST_mangle_partitions.sh"
			]
		}
	]
}
