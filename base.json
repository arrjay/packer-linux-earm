{
	"variables": {
	},
	"builders": [{
		"type": "arm-image",
                "image_type": "raspberrypi",
		"iso_url": "./2020-05-27-raspios-buster-lite-armhf.zip",
		"iso_checksum_type": "sha256",
		"iso_checksum": "f5786604be4b41e292c5b3c711e2efa64b25a5b51869ea8313d58da0b46afc64",
		"target_image_size": 6442450944,
		"output_directory": "base-image"
	}],
	"provisioners": [
                {
                        "type": "shell-local",
                        "execute_command": ["bash", "-c", "{{ .Vars }} {{ .Script }}"],
                        "inline": [ "p=$(pwd) && rm -f $p/packer_cache/imd/install.run && cd vendor/imd && make OUTPUTDIR=$p/packer_cache/imd/" ]
                },
		{
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "TZ=UCT" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"inline": [
                                "mv /etc/ld.so.preload /etc/ld.so.preload.dist",
                                "mkdir /etc/skel/.bash.d"
                        ],
			"skip_clean": true
		},
		{
			"type": "file",
			"source": "./secrets/common",
			"destination": "/tmp"
		},
		{
			"type": "file",
			"source": "files/initonce.sh",
			"destination": "/tmp/initonce.sh"
		},
                {
                        "type": "file",
                        "generated": true,
                        "source": "./packer_cache/imd/install.run",
                        "destination": "/tmp/imd-install.run"
                },
		{
			"type": "file",
			"source": "./vendor/dotfiles/bashrc",
			"destination": "/etc/skel/.bashrc"
		},
		{
			"type": "file",
			"source": "./vendor/dotfiles/bash.d/",
			"destination": "/etc/skel/.bash.d/"
		},
                {
			"type": "file",
			"source": "files/00_pi_onboard.link",
			"destination": "/etc/systemd/network/00_pi_onboard.link"
                },
                {
			"type": "file",
			"source": "files/00_pi2_onboard.link",
			"destination": "/etc/systemd/network/00_pi2_onboard.link"
                },
                {
			"type": "file",
			"source": "files/00_pi3_onboard.link",
			"destination": "/etc/systemd/network/00_pi3_onboard.link"
                },
                {
			"type": "file",
			"source": "files/00_pi3_wifi.link",
			"destination": "/etc/systemd/network/00_pi3_wifi.link"
                },
		{
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "TZ=UCT" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"scripts": [
				"./scripts/common/firstboot.sh",
				"./scripts/common/i18n.sh",
				"./scripts/common/apt-upgrade.sh",
				"./scripts/common/packages.sh",
				"./scripts/common/dhcpd.sh",
				"./scripts/common/kernelsrc.sh",
				"./scripts/common/xt_cgroup.sh",
				"./scripts/common/crypto.sh",
				"./scripts/common/ssm.sh",
				"./scripts/common/base-network.sh",
				"./scripts/common/login-config.sh",
				"./scripts/common/netdata.sh"
			],
			"skip_clean": true
		},
		{
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "TZ=UCT" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"inline": [
                                "mkdir -p /etc/bird",
                                "chmod +x /tmp/imd-install.run",
                                "/tmp/imd-install.run"
                        ],
			"skip_clean": true
		},
		{
			"type": "file",
			"source": "files/imd.conf",
			"destination": "/etc/untrustedhost/imd.conf"
		}
	]
}
