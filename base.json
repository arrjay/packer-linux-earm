{
	"variables": {
	},
	"builders": [{
		"type": "arm-image",
                "image_type": "raspberrypi",
		"iso_url": "./netdata-image/image",
		"iso_checksum_type": "none",
		"output_directory": "base-image"
	}],
	"provisioners": [
                {
                        "type": "shell-local",
                        "execute_command": ["bash", "-c", "{{ .Vars }} {{ .Script }}"],
                        "inline": [ "p=$(pwd) && rm -f $p/packer_cache/imd/install.run && cd vendor/imd && make OUTPUTDIR=$p/packer_cache/imd/" ]
                },
		{
			"type": "file",
			"source": "./secrets/common",
			"destination": "/tmp"
		},
                {
                        "type": "file",
                        "generated": true,
                        "source": "./packer_cache/imd/install.run",
                        "destination": "/tmp/imd-install.run"
                },
		{
			"type": "file",
			"source": "./vendor/dotfiles/bashrc",
			"destination": "/etc/skel/.bashrc"
		},
		{
			"type": "file",
			"source": "./vendor/dotfiles/bash.d/",
			"destination": "/etc/skel/.bash.d/"
		},
                {
			"type": "file",
			"source": "files/00_pi_onboard.link",
			"destination": "/etc/systemd/network/00_pi_onboard.link"
                },
                {
			"type": "file",
			"source": "files/00_pi2_onboard.link",
			"destination": "/etc/systemd/network/00_pi2_onboard.link"
                },
                {
			"type": "file",
			"source": "files/00_pi3_onboard.link",
			"destination": "/etc/systemd/network/00_pi3_onboard.link"
                },
                {
			"type": "file",
			"source": "files/00_pi3_wifi.link",
			"destination": "/etc/systemd/network/00_pi3_wifi.link"
                },
		{
			"type": "file",
			"source": "./files/pimd",
			"destination": "/tmp/pimd"
		},
		{
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "TZ=UCT" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"scripts": [
				"./scripts/common/apt-upgrade.sh",
				"./scripts/common/packages.sh",
				"./scripts/common/dhcpd.sh",
				"./scripts/common/kernelsrc.sh",
				"./scripts/common/xt_cgroup.sh",
				"./scripts/common/crypto.sh",
				"./scripts/common/ssm.sh",
				"./scripts/common/base-network.sh",
				"./scripts/common/login-config.sh"
			],
			"skip_clean": true
		},
		{
			"type": "shell",
			"environment_vars": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "TZ=UCT" ],
			"execute_command": "/bin/chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }}",
			"inline": [
                                "mkdir -p /etc/bird",
                                "chmod +x /tmp/imd-install.run",
                                "/tmp/imd-install.run",
				"mkdir -p /etc/systemd/system/imd.service.d",
				"cp /tmp/pimd/10-after-wpa_supplicant.conf /etc/systemd/system/imd.service.d",
				"cp /tmp/pimd/pi_screen_rotation /usr/lib/untrustedhost/imd/pi_screen_rotation",
				"cp /tmp/pimd/pi_wifi_region /usr/lib/untrustedhost/imd/pi_wifi_region"
                        ],
			"skip_clean": true
		},
		{
			"type": "file",
			"source": "files/imd.conf",
			"destination": "/etc/untrustedhost/imd.conf"
		}
	]
}
